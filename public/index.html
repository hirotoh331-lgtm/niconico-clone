<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ニコニコクローン（Cloudinary版）</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .video-card { border: 1px solid #ddd; padding: 10px; margin-bottom: 20px; border-radius: 8px; }
        video { width: 100%; max-width: 400px; }
        button { cursor: pointer; padding: 5px 10px; }
        .delete-btn { background-color: #ff4444; color: white; border: none; }
    </style>
</head>
<body>

    <h1>動画投稿サイト</h1>

    <div style="background: #f0f0f0; padding: 15px; border-radius: 8px;">
        <h3>動画をアップロード</h3>
        <input type="text" id="titleInput" placeholder="動画のタイトル" required><br><br>
        <input type="file" id="fileInput" accept="video/mp4"><br><br>
        <button onclick="uploadVideo()">アップロードする</button>
        <p id="status"></p>
    </div>

    <hr>

    <div id="videoList"></div>

    <script>
        // ページ読み込み時に一覧を取得
        window.onload = loadVideos;

        // 1. 動画をアップロードする関数
        async function uploadVideo() {
            const title = document.getElementById('titleInput').value;
            const file = document.getElementById('fileInput').files[0];
            const status = document.getElementById('status');

            if (!file) {
                alert("ファイルを選択してください！");
                return;
            }

            status.textContent = "アップロード中...（時間がかかります）";

            const formData = new FormData();
            formData.append('video', file);
            formData.append('title', title);

            try {
                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    status.textContent = "完了しました！";
                    loadVideos(); // 一覧を更新
                } else {
                    status.textContent = "失敗: " + data.error;
                }
            } catch (err) {
                console.error(err);
                status.textContent = "エラーが発生しました";
            }
        }

        // 2. 動画一覧を取得して表示する関数
        async function loadVideos() {
            const res = await fetch('/videos');
            const videos = await res.json();
            const list = document.getElementById('videoList');
            list.innerHTML = ""; // 一旦クリア

            videos.forEach(video => {
                const div = document.createElement('div');
                div.className = 'video-card';
                div.innerHTML = `
                    <h3>${video.title}</h3>
                    <video src="${video.url}" controls></video>
                    <p>ID: ${video.id}</p>
                    <button class="delete-btn" onclick="deleteVideo('${video.id}')">削除する</button>
                `;
                list.appendChild(div);
            });
        }

        // 3. 動画を削除する関数
        async function deleteVideo(id) {
            if (!confirm("本当に削除しますか？（Cloudinaryからも消えます）")) return;

            try {
                const res = await fetch(`/videos/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert("削除しました");
                    loadVideos(); // 一覧を更新
                } else {
                    alert("削除失敗");
                }
            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>